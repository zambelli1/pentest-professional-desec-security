# Dominando o terminal do Linux

## Introdução ao terminal

Aqui iremos ver alguns comandos básicos do terminal:

```bash
pwd #Mostra a localização do diretório atual
ls #Mostra todos os diretórios e arquivos no diretório atual
ls -l #Mostra uma listagem mais detalhada
ls -la #Mostra arquivos ocultos
cd #Muda de diretório (ex: cd Desktop/)
cd .. #Volta diretório
clear #Limpa a o bash
mkdir #Cria um diretório
touch #Criar um arquivo (ex: touch teste)
echo #Printa mensagem na tela
echo Mensagem > arquivo #Escreve a mensagem dentro de um arquivo
echo Mensagem2 >> arquivo #Escreve mensagem no final do arquivo sem sobrescrever
cat #Visualizar o conteúdo de um arquivo
tac #Exibe o arquivo com ordem invertida (tac = cat ao contrário)
rm #Remove arquivo
rm -rf #Remove um diretório com arquivos dentro (ex: rm -rf pasta/)
cp #Copia um arquivo (ex: cp arquivo arquivoCopia)
mv #Move um arquivo (ex: mv arquivoCopia ../)
head #Mostra apenas o começo do arquivo, bom para arquivos grandes
head -n1 #Mostra apenas a primeira linha, -n2 as duas primeiras...
tail #Mostra as ultimas linhas do arquivo
tail -n1 #Mostra apenas as 2 ultimas linhas, -n2 as duas ultimas...
tail -f #Consegue ver em tempo real as alterações, muito utilizado para monitorar logs
```

## Gerenciando Usuários

Se você estiver com usuário root, no terminal ficara com '**#**', caso for um usuário comum, ficará '**$**'.

Exemplo:
- root@pentest:~/Desktop#      (usuário root)
- pedro@pentest~/Desktop$    (usuário comum)

Para adicionarmos um usuário, podemos utilizar o comando:

```bash
adduser pedro
```

Logo após isso, irá pedir a senha, nome completo e outras informações.

Para saber se o usuário foi criado com sucesso, podemos acessar o arquivo que contém todos os usuários do sistema `etc/passwd`:

```bash
cat etc/passwd
```

Se quisermos deletar um usuário, podemos utilizar o comando:

```bash
deluser pedro
```

Outra maneira de criar um usuário de forma mais controlada podemos usar:

```bash
useradd -d /opt/desec -s /bin/bash desec 
#Onde -d é o diretório, -s a shell e desec o nome do usuário
```

Porém com esse comando, não é pedido a senha, para definir a senha, utilizamos o comando:

```bash
passwd desec
```

Para trocar de usuário, podemos utilizar:

```bash
su desec
```

Para dar permissão para esse usuário, precisamos adicionar esse usuário ao grupo **sudo** (OBS: precisa estar em conta root para adicionar o usuário no grupo sudo):

```bash
adduser desec sudo
```

Para revogar uma conta administrativa podemos utilizar:

```bash
deluser desec sudo
```

Podemos adicionar um usuário também abrindo o arquivo `/etc/sudoers` e colocando o usuário na lista e suas permissões:

```bash
nano /etc/sudoers
```

![](images/Pasted%20image%2020240103213507.png)

Para vermos os logs do sistema (tudo o que foi feito no sistema fica registrado) podemos acessar o `/var/log/auth.log`

```bash
cat /var/log/auth.log
```

## Gerenciando a Rede

Aqui vamos aprender como gerenciar a rede, e aprender alguns comandos:

```bash
ifconfig #Mostra as configurações dos adaptadores de rede
```

![](images/Pasted%20image%2020240103214308.png)

Para alterar o endereço IP para outra rede, podemos definir com:

```bash
ifconfig eth0 10.1.1.23 netmask 255.255.255.0
```

Agora se olharmos novamente, veremos que o endereço e mascara de rede terão mudado:

![](images/Pasted%20image%2020240103214612.png)

Mas essa configuração não fica salva, se reiniciarmos o computador iremos perder essa configuração, mas tem um arquivo de configuração que podemos definir essa configuração que será aplicada para quando a máquina for ligada, a configuração já vir pronta.

Para isso iremos abrir o `/etc/network/interfaces`

```bash
nano /etc/network/interfaces
```

E adicionar a configuração desejada:

![](images/Pasted%20image%2020240103215019.png)

Se quisermos mudar o IP e a mascara de rede, podemos alterar para

```
iface eth0 inet static
address 192.168.0.200
netmask 255.255.255.0
gateway 192.168.0.1
```

Para reiniciar o adaptador de rede, podemos utilizar um dos seguintes comandos:

```bash
service networking restart
```

```bash
/etc/init.d/networking restart
```

Para visualizar o Gateway, podemos utilizar o comando:

```bash
route
```

![](images/Pasted%20image%2020240103215640.png)

E para visualizar o IP dele, podemos utilizar:

```bash
route -n
```

![](images/Pasted%20image%2020240103215739.png)

Essa é a nossa rota que faz a gente se conectar com a internet. Por exemplo se utilizarmos o comando `ping` para tentar ver se um site responde, podemos ver:

![](images/Pasted%20image%2020240103215955.png)

Agora se deletarmos essa rota utilizando:

```bash
route del default
```

Se olharmos agora, nossa rota foi excluida:

![](images/Pasted%20image%2020240103220131.png)

E se tentarmos usar o `ping` para algum site, não vamos conseguir:

![](images/Pasted%20image%2020240103220226.png)

Para adicionar a rota novamente, podemos utilizar o comando:

```bash
route add default gw 192.168.0.1
```

Por fim, iremos conhecer o comando `netstat`, usado para visualizar conexões de rede:

```bash
netstat -lt # l = listen, t = tcp
netstat -lu # l = listen, u = udp
```

Se tiver algum serviço rodando, será exibido:

![](images/Pasted%20image%2020240103220545.png)

Se quisermos ver o número dessa porta, podemos adicionar o '**n**' em nossa pesquisa:

```bash
netstat -lnt
```

![](images/Pasted%20image%2020240103220735.png)

E para visualizarmos o nome do programa, podemos adicionar o '**p**' em nossa pesquisa:

![](images/Pasted%20image%2020240103220917.png)

## Editores de texto

### nano

O primeiro editor que iremos conhecer é o **nano**, que é um editor muito bom por ser muito simples, para criar um arquivo basta digitar:

```bash
nano arquivo
```

Irá abrir o editor e você poderá digitar o que quiser dentro desse arquivo.

Com o arquivo aberto podemos utilizar alguns comandos:
- Ctrl + K: Recortar uma linha
- Ctrl + U: Colar essa linha
- Ctrl + W: Procura alguma palavra dentro do arquivo
- Ctrl + X: Sair do editor

### vi e vim

Outro editor que iremos ver é o **vi** que podemos utilizar da seguinte forma:

```bash
vi /etc/passwd
```

Ele tem um diferencial que ele tem cores, porém na hora que você abre o arquivo, você entra no modo de leitura, para inserir dados, basta apertar '**i**' no teclado.

Para deletar uma linha, basta pressionar '**d**' duas vezes.

Para pesquisar, basta apertar '**ESC**' e digitar '**/**'. Ex: '/backup'.

Para sair, basta apertar '**ESC**' e digitar '**:**' e digitar: 
- **q**: Para sair
- **q!**: Para forçar a saída sem salvar
- **wq**: Para salvar e sair

Comandos apresentados na aula de **vim**:

![](images/Pasted%20image%2020240104210539.png)

![](images/Pasted%20image%2020240104210603.png)

![](images/Pasted%20image%2020240104210632.png)

![](images/Pasted%20image%2020240104210703.png)

![](images/Pasted%20image%2020240104210749.png)

### gedit

O **gedit** é um editor gráfico, que ao ser chamado, irá abrir uma tela com o arquivo selecionado (como se fosse o bloco de notas).

```bash
gedit /etc/passwd
```

![](images/Pasted%20image%2020240104205331.png)

### leafpad

O **leafpad** é outra opção de editor gráfico muito simples de usar:

```bash
leafpad /etc/passwd
```

![](images/Pasted%20image%2020240104205501.png)

E ele tem umas opções muito legais, como poder substituir algum padrão em um arquivo, no caso iremos substituir ':' por ',' indo em **Search** > **Replace** e:

![](images/Pasted%20image%2020240104205659.png)

Ao fazer isso, todo o arquivo será alterado:

![](images/Pasted%20image%2020240104205743.png)

## Trabalhando com pacotes

Aqui iremos aprender a gerenciar pacotes no Linux, instalar, atualizar, remover, etc. Todo Linux baseado em Debian mantém um repositório dentro do seguinte diretório:

```bash
cd /etc/apt # Diretório
nano sources.list #Arquivo
```

Caso não tenha nenhum repositório, pode adicionar o mesmo da aula:

```
deb http://http.kali.org/kali kali-rolling main non-free contrib
```

Ou pode ir no site do Kali Linux e pesquisar por sources list.

Podemos utilizar alguns comandos:

```bash
apt update #Atualiza o sistema e o repositório
apt upgrade #Atualiza tudo que estiver desatualizado
apt search PACOTE #Pesquisa por pacotes de acordo com o que você deseja (ex: apt search php7)
apt install PACOTE #Instala o programa desejado (ex: apt install xvnc4viewer)
apt install PACOTE -y #Instala direto com validação automática
apt remove PACOTE #Remove um pacote (ex: apt remove xvnc4viewer)
```

Para instalar pacotes com a extensão '**.deb**' podemos utilizar o **dpkg**:

```bash
dpkg -i ARQUIVO.deb #Instala o arquivo
dpkg -l #Lista arquivos instalados
```

## Trabalhando com serviços

Aqui iremos aprender a gerenciar os serviços em Linux. Antes de iniciarmos algum serviço, vamos ver se tem algum serviço em execução:

```bash
netstat -nlpt
```

![](images/Pasted%20image%2020240104212350.png)

Para iniciar, no caso um serviço de **ssh** podemos utilizar o comando:

```bash
service ssh start
```

Agora, se checarmos novamente, podemos ver o serviço ativo:

![](images/Pasted%20image%2020240104212431.png)

Para iniciar um serviço **apache** podemos digitar:

```bash
service apache2 start
```

Podemos ver ele sendo iniciado na porta 80:

![](images/Pasted%20image%2020240104212540.png)

Para parar um serviço, podemos digitar:

```bash
service apache2 stop
service mysql top
service ssh stop
```

Para reiniciar um serviço, podemos utilizar:

```bash
service ssh restart
```

O problema desse comando é que se a máquina for reiniciada, essa configuração será perdida. Para manter esses serviços ativos quando ela for ligada novamente podemos utilizar:

```bash
update-rc.d ssh enable #Habilita o SSH para iniciar junto com o sistema
update-rc.d ssh disable #Desabilita esse serviço
```

## Localizando arquivos

Uma forma bem simples de localizar arquivos é com o **locate**:

```bash
locate access.log #Irá mostrar as localizações onde tem o arquivo com esse nome
```

![](images/Pasted%20image%2020240104213444.png)

Porém, se um arquivo for inserido recentemente, é necessário atualizar a base de dados utilizando:

```bash
updatedb
```

Outra forma de encontrar programas no sistema é o **whereis**:

```bash
whereis nmap
```

![](images/Pasted%20image%2020240104213521.png)

Para ver apenas o binário, podemos utilizar o **which**:

```bash
which nmap
```

![](images/Pasted%20image%2020240104213543.png)

Outra forma de encontrar arquivos e programas é com o **find**:

```bash
find /root/ -name desecsecurity #Busca dentro do root por nome desecsecurity
find / -name desec* #Procura no sistema inteiro por arquivos que comecem com desec
```

![](images/Pasted%20image%2020240104213637.png)

## Ganhando tempo (grep,awk,cut,sed)

Aqui iremos aprender a ganhar tempo utilizando alguns comandos como **grep**, **awk**, **cut**, **sed**.

### GREP

O **grep** permite combinar padrões para filtrar dentro de um arquivo ou eliminar alguma coisa dentro de uma pesquisa.

Exemplo:

No arquivo **/etc/passwd** queremos filtrar apenas as linhas que contém **/bin/bash**:

![](images/Pasted%20image%2020240104214117.png)

Para isso podemos utilizar o **grep**:

```bash
cat /etc/passwd | grep "bin/bash"
```

Dessa forma, iremos obter apenas as linhas com **/bin/bash**:

![](images/Pasted%20image%2020240104214242.png)

Ou podemos utilizar o **grep** direto, sem concatenar ele:

```bash
grep "/bin/bash" /etc/passwd
grep "/bin/bash" /etc/passwd > temshell #Direcionar o resultado para um arquivo
```

![](images/Pasted%20image%2020240104214428.png)

Para remover algum conteúdo na nossa pesquisa, podemos utilizar o '**-v**'. No caso, para ocultar todas as linhas que contem '**nologin**':

```bash
grep -v "nologin" /etc/passwd
```

![](images/Pasted%20image%2020240104214615.png)

Se quisermos ocultar também as linhas que contém '**/bin/false**' PODERIAMOS usar assim:

```bash
grep -v "nologin" /etc/passwd | grep -v "/bin/false"
```

Porém o comando ficaria muito grande. Para resolver isso, podemos utilizar o **egrep** concatenando as opções com '**|**':

```bash
egrep -v "nologin|/bin/false" /etc/passwd
```

![](images/Pasted%20image%2020240104215131.png)

### AWK

O **awk** é bom para filtrar uma coluna especifica do arquivo.

Exemplo:

Queremos ver apenas os usuários do arquivo '**/etc/passwd**' e ocultar o resto:

![](images/Pasted%20image%2020240104215454.png)

Podemos ver o que separa essa coluna, no caso o '**:**' e passar ele como o divisor e passar qual coluna nós queremos:

```bash
awk -F : '{print #1}' /etc/passwd
```

Assim podemos pegar o '**:**' como divisor e separar a coluna que queremos ver:

![](images/Pasted%20image%2020240104215734.png)

Podemos até ver mais de uma coluna de uma vez:

```bash
awk -F : '{print $1,$6}' temshell
```

![](images/Pasted%20image%2020240104215905.png)

Para ficar mais completo e organizado, podemos personalizar a saída no print:

```bash
awk -F : '{print "O usuario " $1 " tem dir "$6}' temshell
```

![](images/Pasted%20image%2020240104220147.png)

### CUT

O **cut** é muito similar com o **awk**, onde iremos passar um parâmetro, onde será o divisor e quais colunas queremos.

Exemplo:

Seguindo o mesmo exemplo do **awk** com o arquivo '**/etc/passwd**' podemos utilizar:

```bash
cut -d : -f1 /etc/passwd
cut -d : -f6 /etc/passwd
cut -d : -f1,6 /etc/passwd
```

![](images/Pasted%20image%2020240104220436.png)

### SED

O **sed** serve para alterar/corrigir algum conteúdo dentro do arquivo .

Exemplo:

Temos um arquivo com a abreviação dos meses do ano:

![](images/Pasted%20image%2020240104220701.png)

Porém notamos que a abreviação de Fevereiro está errada, está 'EVE' onde era para ser 'FEV'.

Com isso, podemos utilizar o **sed** para corrigir:

```bash
sed 's/EVE/FEV' teste.txt #s = substituir e logo depois passa o que você quer substituir e qual a correção
```

![](images/Pasted%20image%2020240104220939.png)

## Aula de fixação

Aqui iremos juntar tudo que viemos aprendendo e fazer um exercício de fixação colocando tudo em prática. Nosso objetivo é subir um web server  apache, criar um arquivo de texto lá dentro e visualizar os logs em tempo real.

Para começar, iremos ver se tem algum serviço rodando e iremos subir o nosso servidor apache:

```bash
netstat -nlpt
service apache2 start
```

![](images/Pasted%20image%2020240104222538.png)

Podemos ver o status desse serviço:

```bash
service apache2 status
```

![](images/Pasted%20image%2020240104222623.png)

E podemos ver nosso serviço ativo usando o **netstat**:

![](images/Pasted%20image%2020240104222755.png)

Agora iremos para dentro do diretório do **apache**:

```bash
cd /var/www/html/
```

E podemos ver os arquivos dentro desse diretório:

```bash
ls
```

![](images/Pasted%20image%2020240104222929.png)

Para manter o arquivo original do '**index.html**' iremos copiar ele para '**original.html**':

```bash
mv index.html original.html
```

E agora iremos criar um novo arquivo '**index.html**' com o nosso conteúdo:

```bash
nano index.html
```

![](images/Pasted%20image%2020240104223207.png)

E iremos criar um segundo arquivo de texto chamado '**desec.txt**':

```bash
nano desec.txt
```

![](images/Pasted%20image%2020240104223314.png)

Agora antes de testar, vamos acessar o arquivo de logs abrindo um outro terminal. O nome do arquivo de logs do apache, se chama '**access.log**'. Para encontrar ele, vamos utilizar o '**locate**':

```bash
locate access.log
```

![](images/Pasted%20image%2020240104223544.png)

Assim podemos utilizar o comando '**tail -f**' para poder acompanhar os últimos logs:

```bash
tail -f /var/log/apache2/access.log
```

![](images/Pasted%20image%2020240104223708.png)

Agora sempre que houver uma conexão com esse web server, será gerado um log.

Tendo tudo isso pronto, precisamos saber nosso endereço IP:

```bash
ifconfig eth0
```

![](images/Pasted%20image%2020240104223838.png)

Agora podemos abrir o navegador e digitar o nosso IP, nesse caso, '**192.168.0.200**':

![](images/Pasted%20image%2020240104223946.png)

Podemos ver que ele trouxe a nossa mensagem no arquivo '**index.html**' e para acessarmos a outra mensagem no arquivo '**desec.txt**', basta adicionar na URL:

![](images/Pasted%20image%2020240104224107.png)

Podemos ver que foram gerados logs para as nossas ações dentro da página:

![](images/Pasted%20image%2020240104224332.png)

Conseguimos ver o IP, data e hora, requisição feita e navegador.

Um detalhe interessante é que podemos alterar esse arquivo de logs. Por exemplo, em um ataque em que você invadiu um servidor, você pode alterar o IP para não ser descoberto. Apenas apagar os logs poderia ficar estranho e suspeito.

```bash
nano /var/log/apache2/access.log
```

Antes da edição:

![](images/Pasted%20image%2020240104224636.png)

Pós edição:

![](images/Pasted%20image%2020240104224718.png)

